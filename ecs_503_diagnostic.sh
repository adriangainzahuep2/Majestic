#!/bin/bash

# ============================================================================
# Script de Diagn√≥stico para Error 503 en ECS
# ============================================================================

set -e

# Colores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[‚úì]${NC} $1"; }
log_warning() { echo -e "${YELLOW}[!]${NC} $1"; }
log_error() { echo -e "${RED}[‚úó]${NC} $1"; }
log_section() { echo -e "${CYAN}$1${NC}"; }

# Configuraci√≥n
PROJECT_NAME="${PROJECT_NAME:-majestic-app}"
AWS_REGION="${AWS_REGION:-us-east-1}"
ECS_CLUSTER_NAME="${ECS_CLUSTER_NAME:-majestic-app-cluster}"
ECS_SERVICE_NAME="${ECS_SERVICE_NAME:-majestic-app-service}"
CONTAINER_PORT="${CONTAINER_PORT:-3000}"

echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
echo "‚ïë              DIAGN√ìSTICO ERROR 503 - ECS                           ‚ïë"
echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
echo ""

# ============================================================================
# 1. VERIFICAR ESTADO DE LAS TAREAS
# ============================================================================

log_section "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
log_section "1Ô∏è‚É£  VERIFICANDO ESTADO DE LAS TAREAS ECS"
log_section "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
echo ""

SERVICE_INFO=$(aws ecs describe-services \
    --cluster $ECS_CLUSTER_NAME \
    --services $ECS_SERVICE_NAME \
    --region $AWS_REGION 2>/dev/null)

if [ $? -ne 0 ]; then
    log_error "No se pudo obtener informaci√≥n del servicio"
    exit 1
fi

RUNNING_COUNT=$(echo $SERVICE_INFO | jq -r '.services[0].runningCount')
DESIRED_COUNT=$(echo $SERVICE_INFO | jq -r '.services[0].desiredCount')
PENDING_COUNT=$(echo $SERVICE_INFO | jq -r '.services[0].pendingCount')

echo "üìä Estado del Servicio:"
echo "   ‚Ä¢ Running: $RUNNING_COUNT"
echo "   ‚Ä¢ Desired: $DESIRED_COUNT"
echo "   ‚Ä¢ Pending: $PENDING_COUNT"
echo ""

if [ "$RUNNING_COUNT" -eq 0 ]; then
    log_error "NO HAY TAREAS EN EJECUCI√ìN"
    echo ""
    log_info "Verificando eventos del servicio..."
    echo $SERVICE_INFO | jq -r '.services[0].events[0:5][] | "[\(.createdAt)] \(.message)"'
    echo ""
    log_info "Causa m√°s com√∫n: La tarea no puede iniciarse"
    log_info "Verifica los logs de CloudWatch: /ecs/${PROJECT_NAME}"
    exit 1
fi

# Obtener ARN de la tarea en ejecuci√≥n
TASK_ARN=$(aws ecs list-tasks \
    --cluster $ECS_CLUSTER_NAME \
    --service-name $ECS_SERVICE_NAME \
    --region $AWS_REGION \
    --query 'taskArns[0]' \
    --output text)

if [ "$TASK_ARN" == "None" ] || [ -z "$TASK_ARN" ]; then
    log_error "No se encontr√≥ ninguna tarea en ejecuci√≥n"
    exit 1
fi

log_success "Tarea encontrada: ${TASK_ARN##*/}"

# Obtener detalles de la tarea
TASK_DETAILS=$(aws ecs describe-tasks \
    --cluster $ECS_CLUSTER_NAME \
    --tasks $TASK_ARN \
    --region $AWS_REGION)

LAST_STATUS=$(echo $TASK_DETAILS | jq -r '.tasks[0].lastStatus')
HEALTH_STATUS=$(echo $TASK_DETAILS | jq -r '.tasks[0].healthStatus // "UNKNOWN"')
CONTAINER_INSTANCE_ARN=$(echo $TASK_DETAILS | jq -r '.tasks[0].containerInstanceArn')

echo ""
echo "üîç Detalles de la Tarea:"
echo "   ‚Ä¢ Estado: $LAST_STATUS"
echo "   ‚Ä¢ Health: $HEALTH_STATUS"
echo ""

if [ "$HEALTH_STATUS" == "UNHEALTHY" ]; then
    log_error "LA TAREA EST√Å UNHEALTHY"
    log_info "Esto significa que el health check est√° fallando"
fi

# Verificar puerto asignado din√°micamente
HOST_PORT=$(echo $TASK_DETAILS | jq -r '.tasks[0].containers[0].networkBindings[0].hostPort // "none"')

if [ "$HOST_PORT" == "none" ]; then
    log_error "No se encontr√≥ puerto asignado a la tarea"
else
    log_info "Puerto din√°mico asignado: $HOST_PORT"
fi

# ============================================================================
# 2. VERIFICAR TARGET GROUP HEALTH
# ============================================================================

echo ""
log_section "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
log_section "2Ô∏è‚É£  VERIFICANDO HEALTH DEL TARGET GROUP"
log_section "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
echo ""

TG_NAME="${PROJECT_NAME}-tg"
TG_ARN=$(aws elbv2 describe-target-groups \
    --names $TG_NAME \
    --region $AWS_REGION \
    --query 'TargetGroups[0].TargetGroupArn' \
    --output text)

# Obtener configuraci√≥n del health check
TG_CONFIG=$(aws elbv2 describe-target-groups \
    --target-group-arns $TG_ARN \
    --region $AWS_REGION)

HC_PATH=$(echo $TG_CONFIG | jq -r '.TargetGroups[0].HealthCheckPath')
HC_PROTOCOL=$(echo $TG_CONFIG | jq -r '.TargetGroups[0].HealthCheckProtocol')
HC_PORT=$(echo $TG_CONFIG | jq -r '.TargetGroups[0].HealthCheckPort')
HC_INTERVAL=$(echo $TG_CONFIG | jq -r '.TargetGroups[0].HealthCheckIntervalSeconds')
HC_TIMEOUT=$(echo $TG_CONFIG | jq -r '.TargetGroups[0].HealthCheckTimeoutSeconds')
HC_MATCHER=$(echo $TG_CONFIG | jq -r '.TargetGroups[0].Matcher.HttpCode')

echo "‚öôÔ∏è  Configuraci√≥n Health Check:"
echo "   ‚Ä¢ Path: $HC_PATH"
echo "   ‚Ä¢ Protocol: $HC_PROTOCOL"
echo "   ‚Ä¢ Port: $HC_PORT"
echo "   ‚Ä¢ Interval: $HC_INTERVAL segundos"
echo "   ‚Ä¢ Timeout: $HC_TIMEOUT segundos"
echo "   ‚Ä¢ Matcher: HTTP $HC_MATCHER"
echo ""

# Verificar estado de los targets
TARGET_HEALTH=$(aws elbv2 describe-target-health \
    --target-group-arn $TG_ARN \
    --region $AWS_REGION)

echo "üéØ Estado de los Targets:"
echo "$TARGET_HEALTH" | jq -r '.TargetHealthDescriptions[] | "   ‚Ä¢ Target \(.Target.Id):\(.Target.Port) - \(.TargetHealth.State) - \(.TargetHealth.Reason // "N/A")"'
echo ""

HEALTHY_COUNT=$(echo "$TARGET_HEALTH" | jq '[.TargetHealthDescriptions[] | select(.TargetHealth.State == "healthy")] | length')
UNHEALTHY_COUNT=$(echo "$TARGET_HEALTH" | jq '[.TargetHealthDescriptions[] | select(.TargetHealth.State == "unhealthy")] | length')

if [ "$HEALTHY_COUNT" -eq 0 ]; then
    log_error "NO HAY TARGETS HEALTHY - Esta es la causa del 503"
    
    if [ "$UNHEALTHY_COUNT" -gt 0 ]; then
        echo ""
        log_warning "Razones de targets unhealthy:"
        echo "$TARGET_HEALTH" | jq -r '.TargetHealthDescriptions[] | select(.TargetHealth.State == "unhealthy") | "   ‚Ä¢ \(.TargetHealth.Reason): \(.TargetHealth.Description)"'
    fi
else
    log_success "$HEALTHY_COUNT target(s) healthy"
fi

# ============================================================================
# 3. VERIFICAR INSTANCIA EC2 Y CONECTIVIDAD
# ============================================================================

echo ""
log_section "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
log_section "3Ô∏è‚É£  VERIFICANDO INSTANCIA EC2"
log_section "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
echo ""

# Obtener ID de la instancia EC2
CONTAINER_INSTANCE_DETAILS=$(aws ecs describe-container-instances \
    --cluster $ECS_CLUSTER_NAME \
    --container-instances $CONTAINER_INSTANCE_ARN \
    --region $AWS_REGION)

EC2_INSTANCE_ID=$(echo $CONTAINER_INSTANCE_DETAILS | jq -r '.containerInstances[0].ec2InstanceId')

EC2_INFO=$(aws ec2 describe-instances \
    --instance-ids $EC2_INSTANCE_ID \
    --region $AWS_REGION)

PUBLIC_IP=$(echo $EC2_INFO | jq -r '.Reservations[0].Instances[0].PublicIpAddress // "N/A"')
PRIVATE_IP=$(echo $EC2_INFO | jq -r '.Reservations[0].Instances[0].PrivateIpAddress')
INSTANCE_STATE=$(echo $EC2_INFO | jq -r '.Reservations[0].Instances[0].State.Name')
SECURITY_GROUPS=$(echo $EC2_INFO | jq -r '.Reservations[0].Instances[0].SecurityGroups[].GroupId' | tr '\n' ' ')

echo "üñ•Ô∏è  Informaci√≥n de la Instancia:"
echo "   ‚Ä¢ Instance ID: $EC2_INSTANCE_ID"
echo "   ‚Ä¢ Estado: $INSTANCE_STATE"
echo "   ‚Ä¢ IP Privada: $PRIVATE_IP"
echo "   ‚Ä¢ IP P√∫blica: $PUBLIC_IP"
echo "   ‚Ä¢ Security Groups: $SECURITY_GROUPS"
echo ""

if [ "$INSTANCE_STATE" != "running" ]; then
    log_error "La instancia no est√° en estado 'running'"
    exit 1
fi

# Probar conectividad directa si hay IP p√∫blica y puerto asignado
if [ "$PUBLIC_IP" != "N/A" ] && [ "$HOST_PORT" != "none" ]; then
    log_info "Probando conectividad directa a la aplicaci√≥n..."
    
    HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 5 http://$PUBLIC_IP:$HOST_PORT/ 2>/dev/null || echo "000")
    
    if [ "$HTTP_CODE" == "200" ] || [ "$HTTP_CODE" == "301" ] || [ "$HTTP_CODE" == "302" ]; then
        log_success "‚úì Aplicaci√≥n responde en http://$PUBLIC_IP:$HOST_PORT/ (HTTP $HTTP_CODE)"
    else
        log_error "‚úó Aplicaci√≥n NO responde en http://$PUBLIC_IP:$HOST_PORT/ (HTTP $HTTP_CODE)"
        log_warning "Esto indica que el contenedor no est√° escuchando correctamente"
    fi
fi

# ============================================================================
# 4. VERIFICAR SECURITY GROUPS
# ============================================================================

echo ""
log_section "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
log_section "4Ô∏è‚É£  VERIFICANDO SECURITY GROUPS"
log_section "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
echo ""

ALB_SG_NAME="${PROJECT_NAME}-alb-sg"
EC2_SG_NAME="${PROJECT_NAME}-ec2-sg"

ALB_SG_ID=$(aws ec2 describe-security-groups \
    --region $AWS_REGION \
    --filters "Name=group-name,Values=$ALB_SG_NAME" \
    --query 'SecurityGroups[0].GroupId' \
    --output text)

EC2_SG_ID=$(aws ec2 describe-security-groups \
    --region $AWS_REGION \
    --filters "Name=group-name,Values=$EC2_SG_NAME" \
    --query 'SecurityGroups[0].GroupId' \
    --output text)

echo "üõ°Ô∏è  Security Groups:"
echo "   ‚Ä¢ ALB SG: $ALB_SG_ID"
echo "   ‚Ä¢ EC2 SG: $EC2_SG_ID"
echo ""

# Verificar reglas del EC2 SG
log_info "Verificando reglas de ingreso en EC2 SG..."

EC2_SG_RULES=$(aws ec2 describe-security-group-rules \
    --filters "Name=group-id,Values=$EC2_SG_ID" \
    --region $AWS_REGION)

# Verificar si permite tr√°fico desde ALB en puertos din√°micos
DYNAMIC_RULE=$(echo "$EC2_SG_RULES" | jq -r --arg ALB_SG "$ALB_SG_ID" \
    '.SecurityGroupRules[] | select(.IsEgress == false and .ReferencedGroupInfo.GroupId == $ALB_SG and .FromPort == 32768 and .ToPort == 65535)')

if [ -z "$DYNAMIC_RULE" ]; then
    log_error "‚úó Falta regla para puertos din√°micos (32768-65535) desde ALB"
    log_warning "Esta es probablemente la causa del 503"
else
    log_success "‚úì Regla de puertos din√°micos configurada correctamente"
fi

# ============================================================================
# 5. VERIFICAR LOGS DEL CONTENEDOR
# ============================================================================

echo ""
log_section "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
log_section "5Ô∏è‚É£  √öLTIMOS LOGS DEL CONTENEDOR"
log_section "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
echo ""

LOG_GROUP="/ecs/${PROJECT_NAME}"

log_info "Obteniendo √∫ltimos logs de CloudWatch..."

# Obtener el stream m√°s reciente
LATEST_STREAM=$(aws logs describe-log-streams \
    --log-group-name $LOG_GROUP \
    --order-by LastEventTime \
    --descending \
    --max-items 1 \
    --region $AWS_REGION \
    --query 'logStreams[0].logStreamName' \
    --output text 2>/dev/null)

if [ "$LATEST_STREAM" == "None" ] || [ -z "$LATEST_STREAM" ]; then
    log_warning "No se encontraron logs en CloudWatch"
else
    echo ""
    echo "üìã √öltimas 20 l√≠neas de log:"
    echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
    
    aws logs get-log-events \
        --log-group-name $LOG_GROUP \
        --log-stream-name $LATEST_STREAM \
        --limit 20 \
        --region $AWS_REGION \
        --query 'events[*].message' \
        --output text 2>/dev/null | tail -20
    
    echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
fi

# ============================================================================
# 6. VERIFICAR ALB
# ============================================================================

echo ""
log_section "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
log_section "6Ô∏è‚É£  VERIFICANDO APPLICATION LOAD BALANCER"
log_section "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
echo ""

ALB_NAME="${PROJECT_NAME}-alb"
ALB_INFO=$(aws elbv2 describe-load-balancers \
    --names $ALB_NAME \
    --region $AWS_REGION)

ALB_DNS=$(echo $ALB_INFO | jq -r '.LoadBalancers[0].DNSName')
ALB_STATE=$(echo $ALB_INFO | jq -r '.LoadBalancers[0].State.Code')
ALB_SCHEME=$(echo $ALB_INFO | jq -r '.LoadBalancers[0].Scheme')

echo "üåê Informaci√≥n del ALB:"
echo "   ‚Ä¢ DNS: $ALB_DNS"
echo "   ‚Ä¢ Estado: $ALB_STATE"
echo "   ‚Ä¢ Scheme: $ALB_SCHEME"
echo ""

log_info "Probando conectividad al ALB..."
ALB_HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 10 http://$ALB_DNS/ 2>/dev/null || echo "000")

echo "   ‚Ä¢ HTTP Response: $ALB_HTTP_CODE"

if [ "$ALB_HTTP_CODE" == "503" ]; then
    log_error "‚úó ALB devuelve 503 - No hay targets healthy"
elif [ "$ALB_HTTP_CODE" == "200" ] || [ "$ALB_HTTP_CODE" == "301" ] || [ "$ALB_HTTP_CODE" == "302" ]; then
    log_success "‚úì ALB responde correctamente"
fi

# ============================================================================
# RESUMEN Y DIAGN√ìSTICO
# ============================================================================

echo ""
log_section "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
log_section "üìä RESUMEN DEL DIAGN√ìSTICO"
log_section "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
echo ""

if [ "$HEALTHY_COUNT" -eq 0 ]; then
    log_error "PROBLEMA IDENTIFICADO: No hay targets healthy en el Target Group"
    echo ""
    echo "üîß CAUSAS POSIBLES Y SOLUCIONES:"
    echo ""
    
    if [ -z "$DYNAMIC_RULE" ]; then
        echo "   1. ‚ùå Security Group no permite tr√°fico del ALB"
        echo "      Soluci√≥n: Ejecuta el script de correcci√≥n para agregar la regla"
        echo ""
    fi
    
    if [ "$HEALTH_STATUS" == "UNHEALTHY" ]; then
        echo "   2. ‚ùå El health check del contenedor est√° fallando"
        echo "      ‚Ä¢ Verifica que tu app responda en GET $HC_PATH"
        echo "      ‚Ä¢ Verifica los logs para ver errores"
        echo ""
    fi
    
    if [ "$HOST_PORT" == "none" ]; then
        echo "   3. ‚ùå No se asign√≥ puerto din√°mico a la tarea"
        echo "      ‚Ä¢ Verifica la task definition (hostPort debe ser 0)"
        echo ""
    fi
    
    echo "   4. ‚ö†Ô∏è  El contenedor puede no estar escuchando correctamente"
    echo "      ‚Ä¢ Revisa los logs de CloudWatch"
    echo "      ‚Ä¢ Verifica que PORT=$CONTAINER_PORT est√© configurado"
    echo ""
    
elif [ "$HEALTHY_COUNT" -gt 0 ] && [ "$ALB_HTTP_CODE" == "503" ]; then
    log_warning "Situaci√≥n inusual: Hay targets healthy pero el ALB devuelve 503"
    echo ""
    echo "   ‚Ä¢ Espera 30-60 segundos y vuelve a probar"
    echo "   ‚Ä¢ Puede ser un problema temporal de propagaci√≥n"
    
else
    log_success "TODO PARECE ESTAR CORRECTO"
    echo ""
    echo "   ‚úì Tareas ejecut√°ndose: $RUNNING_COUNT"
    echo "   ‚úì Targets healthy: $HEALTHY_COUNT"
    echo "   ‚úì ALB respondiendo correctamente"
    echo ""
    echo "   üåê URL: http://$ALB_DNS"
fi

echo ""
log_section "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
echo ""

# Informaci√≥n adicional
echo "üìå COMANDOS √öTILES:"
echo ""
echo "# Ver logs en tiempo real:"
echo "aws logs tail /ecs/${PROJECT_NAME} --follow --region $AWS_REGION"
echo ""
echo "# Ver estado del servicio:"
echo "aws ecs describe-services --cluster $ECS_CLUSTER_NAME --services $ECS_SERVICE_NAME --region $AWS_REGION"
echo ""
echo "# Forzar nuevo despliegue:"
echo "aws ecs update-service --cluster $ECS_CLUSTER_NAME --service $ECS_SERVICE_NAME --force-new-deployment --region $AWS_REGION"
echo ""