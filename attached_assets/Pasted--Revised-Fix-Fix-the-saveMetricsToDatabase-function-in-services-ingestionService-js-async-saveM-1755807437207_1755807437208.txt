ðŸŽ¯ Revised Fix:
Fix the saveMetricsToDatabase function in services/ingestionService.js:

async saveMetricsToDatabase(userId, uploadId, metrics, testDate) {
  // Load reference metrics from admin spreadsheet
  const referenceMetrics = require('../public/data/metrics.json');
  
  for (const metric of metrics) {
    try {
      // OpenAI already classified to system - map category to system_id
      const systemId = this.mapCategoryToSystemId(metric.category);
      
      // Look up reference range and key metric status from admin spreadsheet
      const referenceData = referenceMetrics.find(ref => 
        ref.metric_name.toLowerCase() === metric.name.toLowerCase()
      );
      
      const referenceRange = referenceData ? 
        `${referenceData.min}-${referenceData.max}` : 
        metric.reference_range; // Fallback to OpenAI extracted range
        
      const isKeyMetric = referenceData ? referenceData.is_key_metric : false;
      
      await pool.query(`
        INSERT INTO metrics (user_id, upload_id, system_id, metric_name, metric_value, metric_unit, reference_range, is_key_metric, test_date)
        VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
        ON CONFLICT (user_id, metric_name, test_date, upload_id) DO UPDATE SET
          metric_value = EXCLUDED.metric_value,
          metric_unit = EXCLUDED.metric_unit,
          reference_range = EXCLUDED.reference_range,
          is_key_metric = EXCLUDED.is_key_metric
      `, [
        userId,
        uploadId,
        systemId,                    // From OpenAI classification
        metric.name,
        metric.value,
        metric.unit,
        referenceRange,              // From admin spreadsheet
        isKeyMetric,                 // From admin spreadsheet
        testDate                     // From Add Data page input
      ]);
    } catch (error) {
      console.error('Error saving metric:', error);
    }
  }
}
// Helper function to map OpenAI categories to system IDs
mapCategoryToSystemId(category) {
  const categoryMap = {
    'cardiovascular': 1,
    'brain': 2, 
    'respiratory': 3,
    'muscle': 4,
    'bone': 5,
    'digestive': 6,
    'hormone': 7,
    'kidney': 8,
    'reproductive': 9,
    'skin': 10,
    'immune': 11,
    'sensory': 12,
    'genetics': 13
  };
  return categoryMap[category.toLowerCase()] || null;
}
Key Changes:

Added testDate parameter to function signature
Included test_date in SQL INSERT (preserves user input)
Kept conflict resolution including test_date
Simplified category mapping to only OpenAI's exact 13 categories
Added genetics mapping (category: 'genetics' â†’ system_id: 13)