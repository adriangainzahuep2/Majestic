Complete Fix for Lab Results Pipeline

ðŸŽ¯ Fix the saveMetricsToDatabase function in services/ingestionService.js:

// 1. Update the function call at line 132
// BEFORE:
await this.saveMetricsToDatabase(userId, uploadId, extractedData.metrics);
// AFTER:
await this.saveMetricsToDatabase(userId, uploadId, extractedData.metrics, testDate);
// 2. Replace the existing saveMetricsToDatabase method with this updated version:
async saveMetricsToDatabase(userId, uploadId, metrics, testDate) {
  // Load reference metrics from admin spreadsheet
  const referenceMetrics = require('../public/data/metrics.json');
  
  for (const metric of metrics) {
    try {
      // OpenAI already classified to system - map category to system_id
      const systemId = this.mapCategoryToSystemId(metric.category);
      
      // Look up reference range and key metric status from admin spreadsheet
      const referenceData = referenceMetrics.find(ref => 
        ref.metric_name.toLowerCase() === metric.name.toLowerCase()
      );
      
      const referenceRange = referenceData ? 
        `${referenceData.min}-${referenceData.max}` : 
        metric.reference_range; // Fallback to OpenAI extracted range
        
      const isKeyMetric = referenceData ? referenceData.is_key_metric : false;
      
      await pool.query(`
        INSERT INTO metrics (user_id, upload_id, system_id, metric_name, metric_value, metric_unit, reference_range, is_key_metric, test_date)
        VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
        ON CONFLICT (user_id, metric_name, test_date, upload_id) DO UPDATE SET
          metric_value = EXCLUDED.metric_value,
          metric_unit = EXCLUDED.metric_unit,
          reference_range = EXCLUDED.reference_range,
          is_key_metric = EXCLUDED.is_key_metric
      `, [
        userId,
        uploadId,
        systemId,                    // From OpenAI classification
        metric.name,
        metric.value,
        metric.unit,
        referenceRange,              // From admin spreadsheet
        isKeyMetric,                 // From admin spreadsheet
        testDate                     // From Add Data page input
      ]);
    } catch (error) {
      console.error('Error saving metric:', error);
    }
  }
}
// 3. Add this new method to the IngestionService class:
mapCategoryToSystemId(category) {
  const categoryMap = {
    'cardiovascular': 1,
    'brain': 2, 
    'respiratory': 3,
    'muscle': 4,
    'bone': 5,
    'digestive': 6,
    'hormone': 7,
    'kidney': 8,
    'reproductive': 9,
    'skin': 10,
    'immune': 11,
    'sensory': 12,
    'genetics': 13
  };
  return categoryMap[category.toLowerCase()] || null;
}
Summary of Changes:

Function Call Update: Added testDate parameter to the existing function call at line 132
Method Replacement: Updated saveMetricsToDatabase to handle OpenAI category mapping
New Method: Added mapCategoryToSystemId method to the IngestionService class
Complete Integration: Preserves user test date input and maps OpenAI categories to proper system IDs
This complete fix addresses the root cause where lab results weren't being categorized into the correct health systems on the dashboard.